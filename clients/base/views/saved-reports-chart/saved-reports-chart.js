/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({plugins:['Dashlet'],reportData:undefined,chartField:undefined,reportOptions:undefined,timerId:undefined,events:{'click a[name=editReport]':'editSavedReport'},initDashlet:function(view){if(this.meta.config){this.meta.panels=this.dashletConfig.dashlet_config_panels;this.getAllSavedReports();}else{var autoRefresh=this.settings.get("auto_refresh");if(autoRefresh>0){if(this.timerId){clearTimeout(this.timerId);}
this._scheduleReload(autoRefresh*1000*60);}}},_scheduleReload:function(delay){this.timerId=setTimeout(_.bind(function(){this.context.resetLoadFlag();this.loadData({success:function(){this._scheduleReload(delay);}});},this),delay);},initialize:function(options){this.reportData=new Backbone.Model();app.view.View.prototype.initialize.call(this,options);},editSavedReport:function(){var currentTargetId=this.dashModel.get('saved_report_id'),params={dashletEdit:1},route=app.bwc.buildRoute('Reports',currentTargetId,'ReportsWizard',params);if(!currentTargetId){return;}
app.alert.show('navigate_confirmation',{level:'confirmation',messages:'LBL_NAVIGATE_TO_REPORTS',onConfirm:_.bind(function(){this.currentLocation=Backbone.history.getFragment();$(window).one('dashletEdit',_.bind(this.postEditListener,this));var dashletEditVisited=false;app.router.on('route',function(){var routeLocation=Backbone.history.getFragment();if(routeLocation.indexOf('dashletEdit=1')>=0){dashletEditVisited=true;}
if(routeLocation.indexOf('dashletEdit=1')<0&&dashletEditVisited){app.router.off('route');$(window).off('dashletEdit');}});app.router.navigate(route,{trigger:true});},this)});},postEditListener:function(event){if(this.currentLocation){app.router.navigate(this.currentLocation,{trigger:true});}},bindDataChange:function(){if(this.meta.config){this.settings.on('change:saved_report_id',function(model){var reportTitle=this.reportOptions[model.get('saved_report_id')];this.settings.set({label:reportTitle});$('[name="label"]').val(reportTitle);},this);}},loadData:function(options){options=options||{};this.getSavedReportById(this.settings.get('saved_report_id'),options);},getAllSavedReports:function(){var params={has_charts:true},url=app.api.buildURL('Reports/saved_reports',null,null,params);app.api.call('read',url,null,{success:_.bind(this.parseAllSavedReports,this)});},parseAllSavedReports:function(reports){this.reportOptions={};_.each(reports,function(report){this.reportOptions[report.id]=report.name;},this);var reportsField=_.find(this.fields,function(field){return field.name=='saved_report_id';});if(reportsField){if(reports&&!this.settings.has('saved_report_id')){this.settings.set({saved_report_id:_.first(reports).id});}
reportsField.items=this.reportOptions;reportsField._render();}},getSavedReportById:function(reportId,options){var dt=this.layout.getComponent('dashlet-toolbar');if(dt){this.$("[data-action=loading]").removeClass(dt.cssIconDefault).addClass(dt.cssIconRefresh);}
app.api.call('create',app.api.buildURL('Reports/chart/'+reportId),null,{success:_.bind(function(serverData){this.reportData.set({rawChartData:serverData.chartData});if(options&&options.success){options.success.apply(this,arguments);}},this),complete:options?options.complete:null});},_render:function(){if(this.meta.config||_.isUndefined(this.chartField)){app.view.View.prototype._render.call(this);}},_renderField:function(field){app.view.View.prototype._renderField.call(this,field);if(_.isUndefined(this.chartField)&&field.name=='chart'){this.chartField=field;}}})