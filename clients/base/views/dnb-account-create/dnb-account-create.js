/*
     * Your installation or use of this SugarCRM file is subject to the applicable
     * terms available at
     * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
     * If you do not agree to all of the applicable terms or do not have the
     * authority to bind the entity as an authorized representative, then do not
     * install or use this SugarCRM file.
     *
     * Copyright (C) SugarCRM Inc. All rights reserved.
     */
({extendsFrom:'DnbView',duns_num:'',importFlag:false,companyList:null,keyword:null,plugins:['Connector'],events:{'click a.dnb-company-name':'dunsClickHandler','click .showMoreData':'showMoreData','click .showLessData':'showLessData','click .importDNBData':'importAccount','click .dnb_checkbox':'importCheckBox','click .clearDNBResults':'clearDNBResults','click .backToList':'backToCompanyList','click [data-action="show-more"]':'invokePagination'},configuredKey:'dnb:account:create:configured',initialize:function(options){this._super('initialize',[options]);this.initDashlet();this.loadData();this.initPaginationParams();this.paginationCallback=this.baseAccountsBAL;},loadData:function(){if(this.disposed){return;}
this.checkConnector('ext_rest_dnb',_.bind(this.loadDataWithValidConnector,this),_.bind(this.handleLoadError,this),['test_passed']);},loadDataWithValidConnector:function(){if(this.disposed)return;this.template=app.template.get(this.name+'.dnb-search-hint');this.render();this.context.on('input:name:keyup',this.dnbSearch,this);this.errmsg=null;},handleLoadError:function(connector){if(this.disposed)return;this.errmsg='LBL_DNB_NOT_CONFIGURED';this.template=app.template.get(this.name+'.dnb-need-configure');this.render();this.context.off('input:name:keyup',this.dnbSearch);},backToCompanyList:function(){if(this.disposed){return;}
this.template=app.template.get(this.name);this.render();this.$('div#dnb-company-list-loading').show();this.$('div#dnb-search-results').hide();this.$('.importDNBData').hide();var dupeCheckParams={'type':'duns','apiResponse':this.currentPage,'module':'dunsPage'};this.baseDuplicateCheck(dupeCheckParams,this.renderPage);},renderCompanyList:function(dnbSrchApiResponse){var dnbSrchResults={};if(this.resetPaginationFlag){this.initPaginationParams();}
if(dnbSrchApiResponse.product){var apiCompanyList=this.getJsonNode(dnbSrchApiResponse.product,this.commonJSONPaths.srchRslt);this.formattedRecordSet=this.formatSrchRslt(apiCompanyList,this.searchDD);this.recordCount=this.getJsonNode(dnbSrchApiResponse.product,this.commonJSONPaths.srchCount);this.paginateRecords();dnbSrchResults.product=this.currentPage;if(this.recordCount){dnbSrchResults.count=this.recordCount;}}else if(dnbSrchApiResponse.errmsg){dnbSrchResults.errmsg=dnbSrchApiResponse.errmsg;}
this.renderPage(dnbSrchResults);},renderPage:function(pageData){if(this.disposed){return;}
this.template=app.template.get(this.name);this.dnbSrchResults=pageData;if(_.isUndefined(pageData.count)){pageData.count=this.recordCount;}
if(pageData.product){this.dnbSrchResults.count=app.lang.get('LBL_DNB_BAL_ACCT_HEADER')+" ("+this.formatSalesRevenue(pageData.count)+")";}else{delete this.dnbSrchResults['count'];}
this.render();this.$('div#dnb-company-list-loading').hide();this.$('div#dnb-search-results').show();if(pageData.product){this.renderPaginationControl();}},invokePagination:function(){this.displayPaginationLoading();this.setPaginationParams();if(this.endRecord>this.apiPageEndRecord){this.apiPageEndRecord=(this.startRecord+this.apiPageSize)-1;this.resetPaginationFlag=false;this.apiPageOffset=this.startRecord;this.paginationCallback(this.setApiPaginationParams(this.balParams),this.renderCompanyList);}else{this.paginateRecords();var pageData={'product':this.currentPage,'count':this.recordCount};this.renderPage(pageData);}},dnbSearch:function(searchString){if(this.disposed){return;}
if(!this.keyword||(this.keyword&&this.keyword!==searchString)){this.keyword=searchString;this.template=app.template.get(this.name);if(this.dnbSrchResults&&this.dnbSrchResults.count){delete this.dnbSrchResults['count'];}
this.render();this.$('table#dnb_company_list').empty();this.$('div#dnb-search-results').hide();this.$('div#dnb-company-list-loading').show();this.$('.clearDNBResults').attr('disabled','disabled');this.$('.clearDNBResults').removeClass('enabled');this.$('.clearDNBResults').addClass('disabled');this.companyList=null;var balParams={'KeywordText':searchString};this.balParams=balParams;this.baseAccountsBAL(this.setApiPaginationParams(balParams),this.renderCompanyList);}},clearDNBResults:function(){this.$('table#dnb_company_list').empty();this.template=app.template.get(this.name+'.dnb-search-hint');this.render();},dunsClickHandler:function(evt){var duns_num=evt.target.id;this.dnbProduct=null;if(duns_num){this.template=app.template.get(this.name+'.dnb-company-details');this.render();this.$('div#dnb-company-detail-loading').show();this.$('div#dnb-company-details').hide();this.$('.importDNBData').hide();this.baseCompanyInformation(duns_num,this.compInfoProdCD.std,app.lang.get('LBL_DNB_BACK_TO_SRCH'),this.renderCompanyDetails);}},renderCompanyDetails:function(companyDetails){if(this.disposed){return;}
this.dnbProduct={};if(companyDetails.product){var duns_num=this.getJsonNode(companyDetails.product,this.appendSVCPaths.duns);if(!_.isUndefined(duns_num)){this.duns_num=duns_num;this.dnbProduct.product=this.formatCompanyInfo(companyDetails.product,this.accountsDD);}}
if(companyDetails.errmsg){this.dnbProduct.errmsg=companyDetails.errmsg;}
this.render();this.$('div#dnb-company-detail-loading').hide();this.$('div#dnb-company-details').show();if(this.dnbProduct.errmsg){this.$('.importDNBData').hide();}else{this.$('.importDNBData').show();}},importAccount:function(){this.importAccountsData(this.importFlag);this.importFlag=true;},importCheckBox:function(){var dnbCheckBoxes=this.$('.dnb_checkbox:checked');this.$('.importDNBData').toggleClass('disabled',dnbCheckBoxes.length===0);}})