nv.models.funnel=function(){var margin={top:0,right:0,bottom:0,left:0},width=960,height=500,y=d3.scale.linear(),id=Math.floor(Math.random()*10000),getX=function(d){return d.x;},getY=function(d){return d.height;},getV=function(d){return d.value;},forceY=[0],clipEdge=true,yDomain,delay=0,funnelOffset=0,durationMs=0,fmtValueLabel=function(d){return d.label||d.value||d;},color=nv.utils.defaultColor(),fill=color,classes=function(d,i){return'nv-bar positive';},dispatch=d3.dispatch('chartClick','elementClick','elementDblClick','elementMouseover','elementMouseout','elementMousemove');var y0;function chart(selection){selection.each(function(data){var availableWidth=width-margin.left-margin.right,availableHeight=height-margin.top-margin.bottom,container=d3.select(this),labelBoxWidth=20,funnelTotal=0,funnelArea=0,funnelBase=0,funnelShift=0,funnelMinHeight=32,funnelRight=0;var w=Math.max(Math.min(availableHeight / 1.1,availableWidth-funnelOffset),40),r=0.3,c=availableWidth / 2;availableHeight=Math.min(availableHeight,(w-w*r)/(2*r));function pointsTrapezoid(y0,y1,h){var w0=w / 2-r*y0,w1=w / 2-r*y1;return((c-w0)+','+(y0*h)+' '+
(c-w1)+','+(y1*h)+' '+
(c+w1)+','+(y1*h)+' '+
(c+w0)+','+(y0*h));}
function heightTrapezoid(a,b){var x=b / r / 2;return Math.abs(Math.sqrt(a / r+x*x))-x;}
function areaTrapezoid(h,w){return h*(w-h*r);}
funnelArea=areaTrapezoid(availableHeight,w);funnelBase=w-2*r*availableHeight;data.map(function(series,i){series.values=series.values.map(function(point){point.series=i;if(typeof point.value=='undefined'){point.value=point.y;}
funnelTotal+=point.value;return point;});return series;});data.map(function(series,i){series.values=series.values.map(function(point){point.height=0;if(funnelTotal>0){point.height=heightTrapezoid(funnelArea*point.value / funnelTotal,funnelBase);}
if(point.height<funnelMinHeight / 2){funnelShift+=point.height-funnelMinHeight / 2;point.height=funnelMinHeight / 2;}else if(funnelShift<0&&point.height+funnelShift>funnelMinHeight / 2){point.height+=funnelShift;funnelShift=0;}
funnelBase+=2*r*point.height;return point;});return series;});data=d3.layout.stack().offset('zero').values(function(d){return d.values;}).y(getY)(data);var seriesData=(yDomain)?[]:data.map(function(d){return d.values.map(function(d,i){return{x:getX(d,i),y:getY(d,i),y0:d.y0};});});y.domain(yDomain||d3.extent(d3.merge(seriesData).map(function(d){return d.y+d.y0;}).concat(forceY))).range([availableHeight,0]);y0=y0||y;var wrap=container.selectAll('g.nv-wrap.nv-funnel').data([data]);var wrapEnter=wrap.enter().append('g').attr('class','nvd3 nv-wrap nv-funnel');var defsEnter=wrapEnter.append('defs');var gEnter=wrapEnter.append('g');var g=wrap.select('g');chart.gradient=function(d,i,p){return nv.utils.colorLinearGradient(d,id+'-'+i,p,color(d,i),wrap.select('defs'));};gEnter.append('g').attr('class','nv-groups');wrap.attr('transform','translate('+margin.left+','+margin.top+')');defsEnter.append('clipPath').attr('id','nv-edge-clip-'+id).append('rect');wrap.select('#nv-edge-clip-'+id+' rect').attr('width',availableWidth).attr('height',availableHeight);g.attr('clip-path',clipEdge?'url(#nv-edge-clip-'+id+')':'');var groups=wrap.select('.nv-groups').selectAll('.nv-group').data(function(d){return d;},function(d){return d.key;});groups.enter().append('g').attr('class',function(d,i){return this.getAttribute('class')||classes(d,i);}).attr('fill',function(d,i){return this.getAttribute('fill')||fill(d,i);});groups.exit().transition().duration(durationMs).selectAll('polygon.nv-bar').delay(function(d,i){return i*delay / data[0].values.length;}).attr('points',function(d){return pointsTrapezoid(y(d.y0),y(d.y0+d.y),0);}).remove();groups.exit().transition().duration(durationMs).selectAll('g.nv-label-value').delay(function(d,i){return i*delay / data[0].values.length;}).attr('y',0).attr('transform','translate('+c+',0)').style('fill-opacity',1e-6).remove();groups.classed('hover',function(d){return d.hover;}).classed('nv-active',function(d){return d.active==='active';}).classed('nv-inactive',function(d){return d.active==='inactive';});var funs=groups.selectAll('polygon.nv-bar').data(function(d,i){return d.values;});var funsEnter=funs.enter().append('polygon').attr('class',function(d,i){return'nv-bar positive';}).attr('points',function(d){return pointsTrapezoid(y(d.y0),y(d.y0+d.y),0);}).style('stroke','#ffffff').style('stroke-width',3).style('stroke-opacity',1);funs.transition().duration(durationMs).delay(function(d,i){return i*delay / data[0].values.length;}).attr('points',function(d){var _points;if(d.active&&d.active==='active'){w=w*1.05;_points=pointsTrapezoid(y(d.y0),y(d.y0+d.y),1);w=w / 1.05;}else{_points=pointsTrapezoid(y(d.y0),y(d.y0+d.y),1);}
return _points;});funs.on('mouseover',function(d,i){d3.select(this).classed('hover',true);dispatch.elementMouseover({value:getV(d,i),point:d,series:data[d.series],pos:[d3.event.pageX,d3.event.pageY],pointIndex:i,seriesIndex:d.series,e:d3.event});}).on('mouseout',function(d,i){d3.select(this).classed('hover',false);dispatch.elementMouseout({value:getV(d,i),point:d,series:data[d.series],pointIndex:i,seriesIndex:d.series,e:d3.event});}).on('mousemove',function(d,i){dispatch.elementMousemove({point:d,pointIndex:i,pos:[d3.event.pageX,d3.event.pageY],id:id});}).on('click',function(d,i){dispatch.elementClick({value:getV(d,i),point:d,series:data[d.series],pos:[d3.event.pageX,d3.event.pageY],pointIndex:i,seriesIndex:d.series,e:d3.event});d3.event.stopPropagation();}).on('dblclick',function(d,i){dispatch.elementDblClick({value:getV(d,i),point:d,series:data[d.series],pos:[d3.event.pageX,d3.event.pageY],pointIndex:i,seriesIndex:d.series,e:d3.event});d3.event.stopPropagation();});var lblValue=groups.selectAll('.nv-label-value').data(function(d){return d.values;});var lblValueEnter=lblValue.enter().append('g').attr('class','nv-label-value').attr('transform','translate('+c+',0)');lblValueEnter.append('text').attr('class','nv-label').attr('x',0).attr('y',-4).attr('text-anchor','middle').style('font-size','11px').style('stroke','none').style('pointer-events','none').style('fill',function(d,i,j){var backColor=d3.select(this.parentNode).style('fill'),textColor=nv.utils.getTextContrast(backColor,i);return textColor;});lblValueEnter.append('text').attr('class','nv-value').attr('x',0).attr('y',11).attr('text-anchor','middle').style('font-size','15px').style('stroke','none').style('pointer-events','none').style('fill',function(d,i,j){var backColor=d3.select(this.parentNode).style('fill'),textColor=nv.utils.getTextContrast(backColor,i);return textColor;});lblValue.transition().duration(durationMs).delay(function(d,i){return i*delay / data[0].values.length;}).attr('transform',function(d){var o=(y(d.y0+d.y / 2));return'translate('+c+','+o+')';});lblValue.select('text.nv-label').text(function(d){var s=data[d.series],l=s.key+(s.count?' ('+s.count+')':'');return(Math.round(d.height)<=funnelMinHeight)?'':l;});lblValue.select('text.nv-value').text(function(d){return(Math.round(d.height)<=funnelMinHeight)?'':fmtValueLabel(d);});y0=y.copy();});return chart;}
chart.dispatch=dispatch;chart.color=function(_){if(!arguments.length)return color;color=_;return chart;};chart.fill=function(_){if(!arguments.length)return fill;fill=_;return chart;};chart.classes=function(_){if(!arguments.length)return classes;classes=_;return chart;};chart.gradient=function(_){if(!arguments.length)return gradient;gradient=_;return chart;};chart.x=function(_){if(!arguments.length)return getX;getX=_;return chart;};chart.y=function(_){if(!arguments.length)return getY;getY=_;return chart;};chart.margin=function(_){if(!arguments.length)return margin;margin=_;return chart;};chart.width=function(_){if(!arguments.length)return width;width=_;return chart;};chart.height=function(_){if(!arguments.length)return height;height=_;return chart;};chart.xScale=function(_){if(!arguments.length)return x;x=_;return chart;};chart.yScale=function(_){if(!arguments.length)return y;y=_;return chart;};chart.yDomain=function(_){if(!arguments.length)return yDomain;yDomain=_;return chart;};chart.forceY=function(_){if(!arguments.length)return forceY;forceY=_;return chart;};chart.id=function(_){if(!arguments.length)return id;id=_;return chart;};chart.delay=function(_){if(!arguments.length)return delay;delay=_;return chart;};chart.clipEdge=function(_){if(!arguments.length)return clipEdge;clipEdge=_;return chart;};chart.fmtValueLabel=function(_){if(!arguments.length)return fmtValueLabel;fmtValueLabel=d3.functor(_);return chart;};chart.offset=function(_){if(!arguments.length)return funnelOffset;funnelOffset=_;return chart;};return chart;}